# Quick Start: Integrating Azure OpenAI with ACS Job Router

## Prerequisites
- Create an Azure OpenAI resource. [Setup Guide](https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/create-resource?pivots=web-portal)
- Create an Azure Communication Services resource. [Setup Guide](https://learn.microsoft.com/en-us/azure/communication-services/quickstarts/create-communication-resource?tabs=windows&pivots=platform-azp#clean-up-resources)
- Clone the GitHub solution. [Integrating Azure OpenAI with ACS Job Router](https://github.com/Azure-Samples/communication-services-dotnet-quickstarts/tree/main/JobRouterOpenAIIntegration)
- Visual Code Installed. [Visual Code](https://code.visualstudio.com/)
- Azure Functions Extension for Visual Code. [Azure Function Extension with Visual Code](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions)

## Overview

This quickstart demonstates how to integrate Azure Open AI with ACS Job Router to use Azure Open AI to intelligently choose the best suited worker based on performance indicators for an incoming job.

### Console Application
- Manages ACS resources including policies and queues.
- Simulates job queuing and allocation.

### Azure Function Project
- Hosts API for Azure OpenAI integration.
- Manages worker scoring and job labels.

#### This guide covers two main projects:
1. A .NET console application to interact with ACS Job Router.
2. An Azure Function project for OpenAI integration with ACS Job Router.
 
#### The console application is setup to provision the following ACS resources:
1. A distribution policy that lets ACS Job Router understand how to generate offers for workers. This application is configured to provsiona Best-Worker mode distribution policy that uses a Function Router Rule for scoring workers. 
2. A queue with the best-worker mode distribution policy attached.
3. 5 workers that will be registered to a queue with 3 chosen performance indicators values populated as labels.
4. Creates a Job in ACS Job Router and lets the user know which worker Azure OpenAI has scored the highest based on the performance indicator labels.

![SequenceDiagram](./media/Overview%20sequence%20diagram.png)
 
#### The Azure Function project is setup to interact with a deployed Azure OpenAI model.
1. The Azure function receive a request from ACS Job Router with a payload containing the worker's labels (performance indicators).
2. The Azure function extracts those values from the request.
3. The Azure function has been preconfigured with a prompt to explain to the Azure Open AI model how to interpret each one of these performance indicators and to ask Azure OpenAI to score each worker based on these values to find the most suitable agent for a new job.
> **Note:** The prompt can be updated for any desired outcome. For example you could modify the prompt to weigh the Average Handling Time as the most important datapoint or ask the model to optimize for customer satisfaction. 
4. The Azure Function sends a request with the configured prompts and worker performance indicators, Azure OpenAI responds back with a JSON Object containing the scores generated by Azure Open AI.
5. The Azure Function then sends these scores back to ACS Job Router.
6. ACS Job Router then sends an offer to the worker that was scored the highest from Azure OpenAI.

## Performance indicators used in this project

In this guide we've chosen 3 performance indicators based on typical contact center performance data points.
Workers are evaluated based on:
- **CSAT**: Customer satisfaction.
- **Outcome**: Issue resolution rate.
- **AHT**: Average handling time.


## Understanding ACS Job Router
- Learn about the ACS Job Router. [Job Router Concepts](https://learn.microsoft.com/en-us/azure/communication-services/concepts/router/concepts)
- Configure the BestWorker Distribution Policy using an Azure Function Scoring Rule. [Customize Worker Scoring](https://learn.microsoft.com/en-us/azure/communication-services/how-tos/router-sdk/customize-worker-scoring)

## Understanding Azure Function Deployments
- Learn about Azure Function Deployments [Azure Function Deployments](https://learn.microsoft.com/en-us/azure/azure-functions/functions-deployment-technologies?tabs=windows)

## Understanding Azure OpenAI Prompts
- Learn about Azure Open AI prompt Engineering Techniques. [Prompt Engineering Techniques](https://learn.microsoft.com/en-us/azure/ai-services/openai/concepts/advanced-prompt-engineering?pivots=programming-language-chat-completions)

## Deployment and Execution

1. Open the OpenAiScoringFunction project in Visual Code with the Azure Function Extension installed. Select 'Create Function App in Azure...'

<p align="center">
  <img src="./media/CreateAzureFunctionFromCode.png" alt="CreateFunctionApp"/>
</p>

2. After selecting your Subscription enter a unique name for your function app.

<p align="center">
  <img src="./media/FunctionSelectSubscription.png" alt="SetFunctionName"/>
</p>

3. Once your Function App has been created, right click on your App and Select 'Deploy Function App...'
4. Open the Azure portal and go to your Azure OpenAI resource go to Azure AI Studio. From here navigate to the Deployments tab and select "+ Create new deployment"
    - a. Select a model that can perform completions 

    [Azure OpenAI Service models](https://learn.microsoft.com/en-us/azure/ai-services/openai/concepts/models)
    - b. Give your model a Deployment name and select “Create”

<p align="center">
  <img src="./media/AOAIModelCreation.png" alt="CreateAOI_Model"/>
</p>

5. Once your Azure OpenAI Model has been created copy down the 'Endpoint', 'Keys', and 'Region'

<p align="center">
  <img src="./media/AOI_KeyAndEndpoint.png" alt="AOI_Details"/>
</p>

6. In the Azure Portal navigate to your newly created Function App Enviornmental Variables blade and create the following variables:

| Name  | Value | Description         |
|-------|-------|---------------------|
| OpenAIBaseURI | {Endpoint}| Endpoint URI from OpenAI Resource   |
| OpenAIAPIKey | {Key}| Key from OpenAI Resource  |
| DeploymentName | {DeploymentName}| Deployment Name from OpenAI Resource   |
| Preprompt | You are helping pair a customer with an agent in a contact center. You will evaluate the best available agent based on their performance indicators below. Note that CSAT holds the average customer satisfaction score between 1 and 3, higher is better.Outcome is a score between 0 and 1, higher is better. AHT is average handling time, lower is better. If AHT provided is 00:00, please ignore it in the scoring.| Prompt containing preprocessing instructions for the Azure OpenAI model  |
| Postprompt | Respond with only a json object with agent Id as the key, and scores based on suitability for this customer as the value in a range of 0 to 1. Do not include any other information.| Prompt containing postprocessing instructions for the Azure OpenAI model   |
| DefaultCSAT | 1.5| Default CSAT score for workers missing this label   |
| DefaultOutcome | 0.5| Default Outcome score for workers missing this label   |
| DefaultAHT | 10:00| Default AHT for workers missing this label   |
7. On the Overview blade of your function app, copy the function URL, one the Functios--> Keys blade of your function app copy the master or default key.
8. Navigate to you ACS resource and copy down your connection string.
9. Open the JR_AOAI_Integration Console application and open the appsettings.json file to update the following config settings.

![VariableDefintions](./media/AppSetingsConfig.png)
10. Run the application and follow the on-screen instructions to Create a Job


## Experimentation

Various experiments can be done within this project such as:

1.	Experimenting with the PrePrompt string (On the Environment Variables of the Azure Function) can be done to further tune scores provided by Azure OpenAi.
2.	Add additional performance indicator labels to workers, updating the OpenAiScorer class in the OpenAIScorerFunction project to account for new labels and updating the prompts, default performance indicatorsEnvironment Variables of your function and add the new performance indicators into appSettings.json file under each worker.
3.	Implement logic to update the values of the performance indicator labels as jobs are completed by each worker. This could be by adding persistence or cache to your application to store these values. Labels are routable attributes in Job Router. If a workers labels are updated any offers that issued for that worker will be revoked, consider updating labels at a point when worker is not expecting offers (AvailableForOffers – false, or when the worker’s capacity is consumed).
