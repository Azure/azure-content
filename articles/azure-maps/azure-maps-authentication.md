---
title: Authentication with Microsoft Azure Maps
titleSuffix: Azure Maps
description: "Learn about two ways of authenticating requests in Azure Maps: shared key authentication and Azure Active Directory (Azure AD) authentication."
author: anastasia-ms
ms.author: v-stharr
ms.date: 05/25/2021
ms.topic: conceptual
ms.service: azure-maps
services: azure-maps

ms.custom: mvc
---

# Authentication with Azure Maps

Azure Maps supports two ways to authenticate requests: Shared Key authentication and [Azure Active Directory (Azure AD)](../active-directory/fundamentals/active-directory-whatis.md) authentication. This article explains both authentication methods to help guide your implementation of Azure Maps services.

> [!NOTE]
> To improve secure communication with Azure Maps, we now support Transport Layer Security (TLS) 1.2, and we're retiring support for TLS 1.0 and 1.1. If you currently use TLS 1.x, evaluate your TLS 1.2 readiness and develop a migration plan with the testing described in [Solving the TLS 1.0 Problem](/security/solving-tls1-problem).

## Shared Key authentication

Primary and secondary keys are generated after the Azure Maps account is created. You're encouraged to use the primary key as the subscription key when calling Azure Maps with shared key authentication. Shared Key authentication passes a key generated by an Azure Maps account to an Azure Maps service. For each request to Azure Maps services, add the _subscription key_ as a parameter to the URL. The secondary key can be used in scenarios like rolling key changes.

For information about viewing your keys in the Azure portal, see [Manage authentication](./how-to-manage-authentication.md#view-authentication-details).

> [!NOTE]
> Primary and Secondary keys should be treated as sensitive data. The shared key is used to authenticate all Azure Maps REST APIs. Users who use a shared key should abstract the API key away, either through environment variables or secure secret storage, where it can be managed centrally.

## Azure AD authentication

Azure Subscriptions are provided with an Azure AD tenant to enable fine grained access control. Azure Maps offers authentication for Azure Maps services using Azure AD. Azure AD provides identity-based authentication for users and applications registered in the Azure AD tenant.

Azure Maps accepts **OAuth 2.0** access tokens for Azure AD tenants associated with an Azure subscription that contains an Azure Maps account. Azure Maps also accepts tokens for:

- Azure AD users
- Partner applications that use permissions delegated by users
- Managed identities for Azure resources

Azure Maps generates a _unique identifier (client ID)_ for each Azure Maps account. You can request tokens from Azure AD when you combine this client ID with additional parameters.

For more information about how to configure Azure AD and request tokens for Azure Maps, see [Manage authentication in Azure Maps](./how-to-manage-authentication.md).

For general information about authenticating with Azure AD, see [What is authentication?](../active-directory/develop/authentication-vs-authorization.md).

### Managed identities for Azure resources and Azure Maps

[Managed identities for Azure resources](../active-directory/managed-identities-azure-resources/overview.md) provide Azure services with an automatically managed application based security principal that can authenticate with Azure AD. With Azure role-based access control (Azure RBAC), the managed identity security principal can be authorized to access Azure Maps services. Some examples of managed identities include: Azure App Service, Azure Functions, and Azure Virtual Machines. For a list of managed identities, see [managed identities for Azure resources](../active-directory/managed-identities-azure-resources/services-support-managed-identities.md).

### Configuring application Azure AD authentication

Applications will authenticate with the Azure AD tenant using one or more supported scenarios provided by Azure AD. Each Azure AD application scenario represents different requirements based on business needs. Some applications may require user sign-in experiences and other applications may require an application sign-in experience. For more information, see [Authentication flows and application scenarios](../active-directory/develop/authentication-flows-app-scenarios.md).

After the application receives an access token, the SDK and/or application sends an HTTPS request with the following set of required HTTP headers in addition to other REST API HTTP headers:

| Header Name    | Value               |
| :------------- | :------------------ |
| x-ms-client-id | 30d7cc….9f55        |
| Authorization  | Bearer eyJ0e….HNIVN |

> [!NOTE] > `x-ms-client-id` is the Azure Maps account-based GUID that appears on the Azure Maps authentication page.

Here's an example of an Azure Maps route request that uses an Azure AD OAuth Bearer token:

```http
GET /route/directions/json?api-version=1.0&query=52.50931,13.42936:52.50274,13.43872
Host: atlas.microsoft.com
x-ms-client-id: 30d7cc….9f55
Authorization: Bearer eyJ0e….HNIVN
```

For information about viewing your client ID, see [View authentication details](./how-to-manage-authentication.md#view-authentication-details).

## Authorization with role-based access control

Azure Maps supports access to all principal types for [Azure role-based access control (Azure RBAC)](../role-based-access-control/overview.md) including: individual Azure AD users, groups, applications, Azure resources, and Azure Managed identities. Principal types are granted a set of permissions, also known as a role definition. A role definition provides permissions to REST API actions. Applying access to one or more Azure Maps accounts is known as a scope. When applying a principal, role definition, and scope then a role assignment is created.

The next sections discuss concepts and components of Azure Maps integration with Azure RBAC. As part of the process to set up your Azure Maps account, an Azure AD directory is associated to the Azure subscription, which the Azure Maps account resides.

When you configure Azure RBAC, you choose a security principal and apply it to a role assignment. To learn how to add role assignments on the Azure portal, see [Assign Azure roles](../role-based-access-control/role-assignments-portal.md).

### Picking a role definition

The following role definition types exist to support application scenarios.

| Azure Role Definition                    | Description                                                                                                    |
| :--------------------------------------- | :------------------------------------------------------------------------------------------------------------- |
| Azure Maps Search and Render Data Reader | Provides access to only search and render Azure Maps REST APIs to limit access to basic web browser use cases. |
| Azure Maps Data Reader                   | Provides access to immutable Azure Maps REST APIs.                                                             |
| Azure Maps Data Contributor              | Provides access to mutable Azure Maps REST APIs. Mutability is defined by the actions: write and delete.       |
| Custom Role Definition                   | Create a crafted role to enable flexible restricted access to Azure Maps REST APIs.                            |

Some Azure Maps services may require elevated privileges to perform write or delete actions on Azure Maps REST APIs. Azure Maps Data Contributor role is required for services which provide write or delete actions. The following table describes which services Azure Maps Data Contributor is applicable for when using write or delete actions on the given service. If only read actions are used on the service, then Azure Maps Data Reader can be used instead of Azure Maps Data Contributor.

| Azure Maps Service     | Azure Maps Role Definition  |
| :--------------------- | :-------------------------- |
| Data                   | Azure Maps Data Contributor |
| Creator                | Azure Maps Data Contributor |
| Spatial                | Azure Maps Data Contributor |
| Batch Search and Route | Azure Maps Data Contributor |

For information about viewing your Azure RBAC settings, see [How to configure Azure RBAC for Azure Maps](./how-to-manage-authentication.md).

#### Custom role definitions

One aspect of application security is to apply the principle of least privilege. This principle implies that the security principal should only be allowed the access which is required, and have no additional access. Creating custom role definitions can support use cases which require further granularity to access control. To create a custom role definition, you can select specific data actions to include or exclude for the definition.

The custom role definition can then be used in a role assignment for any security principal. To learn more about Azure custom role definitions, see [Azure custom roles](../role-based-access-control/custom-roles.md).

Here are some example scenarios where custom roles can improve application security.

| Scenario                                                                                                                                                                                                                 | Custom Role Data Action(s)                                                                                                                  |
| :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------ |
| A public facing or interactive sign-in web page with base map tiles and no other REST APIs.                                                                                                                              | `Microsoft.Maps/accounts/services/render/read`                                                                                              |
| An application which only requires reverse geocoding and no other REST APIs.                                                                                                                                             | `Microsoft.Maps/accounts/services/search/read`                                                                                              |
| A role for a security principal which requests reading of Azure Maps Creator based map data and base map tile REST APIs.                                                                                                 | `Microsoft.Maps/accounts/services/data/read`, `Microsoft.Maps/accounts/services/render/read`                                                |
| A role for a security principal which requires reading, writing, and deleting of Creator based map data. This can be defined as a map data editor role but does not allow access to other REST APIs like base map tiles. | `Microsoft.Maps/accounts/services/data/read`, `Microsoft.Maps/accounts/services/data/write`, `Microsoft.Maps/accounts/services/data/delete` |

### Understanding scope

When creating a role assignment, it is defined within the Azure resource hierarchy. At the top of the hierarchy is a [management group](../governance/management-groups/overview.md) and the lowest is an Azure resource, like an Azure Maps account.
Assigning a role assignment to a resource group can enable access to multiple Azure Maps accounts or resources in the group.

> [!TIP]
> Microsoft's general recommendation is to assign access to the Azure Maps account scope because it prevents **unintended access to other Azure Maps accounts** existing in the same Azure subscription.

## Shared Access Signature token authentication

[!INCLUDE [preview features callout](./includes/preview-callout.md)]

> [!IMPORTANT]
> This authentication is more conducive to an environment where Azure AD integration is not possible or not preferred.

Shared Access Signature tokens (SAS) are authentication tokens which are composed from JSON Web token (JWT) format and are cryptographically signed to prove authentication for an application to the Azure Maps REST APIs. A SAS token is created by first integrating an existing or new Azure User Assigned Managed Identity to an Azure Map account of your Azure subscription. The User Assigned Managed Identity is given authorization to the Azure Map account through Azure RBAC using one of the built-in or custom role definitions.

Functional key differences of SAS token from Azure AD Access tokens:

- Lifetime of a token for a max expiration of 1 year (365 days).
- Azure location and geography access control per token.
- Rate limits per token for an approximate of 1 to 500 requests per second.
- Private keys of the token are the primary and secondary keys of an Azure Maps account resource.
- Service Principal object for authorization is supplied by a User Assigned Managed Identity.

SAS tokens are immutable, this means that once a token is created, the SAS token is valid until the expiry has been met and the configuration of the allowed regions, rate limits, and user assigned managed identity cannot be changed. Read more below on [understanding access control](./azure-maps-authentication.md/#Understanding-SAS-token-Access-Control) for SAS token revocation and changes to access control.

### Understanding SAS token Rate Limits

**SAS token maximum rate limit can control billing for an Azure Maps resource**

By specifying a maximum rate limit on the token, the excess rate will not be billed to the account allowing the application to provide an upper limit of billable transactions for the account when using the token. However, the application will receive client error responses with `429 (TooManyRequests)`. It is the responsibility of the application to manage retry and distribution of SAS tokens. There is no upper bound on how many SAS tokens can be created for an account. To allow for an increase or decrease in an existing token's limit; a new SAS token must be created.

Estimated Example:

| Approximate Maximum Rate Per Second | Actual Rate Per Second | Duration of sustained rate in seconds | Total billable transactions |
| :---------------------------------- | :--------------------- | :------------------------------------ | :-------------------------- |
| 10                                  | 20                     | 600                                   | 6000                        |

This is an estimate, actual rate limits vary slightly based on the Azure Maps ability to enforce consistency with in a span of time. However, this allows for preventive control of billing cost.

**Rate limits are enforced per Azure location, not globally or geographically**

As an example, single SAS token with a maximum limit defined with 10 may use throughput to the limit in the `East US` location and if that same token is used on the `West US 2` location the same throughput is allowed until the 10. To control costs and improve predictability, we recommend:

1. Create SAS tokens with designated allowed Azure locations for targeted geography. Continue reading to understand creating SAS tokens.
1. Use geographic data-plane REST API endpoints, `https://us.atlas.microsof.com` or `https://eu.atlas.microsoft.com`.

**Default rate limits precede over SAS token rate limits**

As described in [Azure Maps rate limits](./azure-maps-qps-rate-limits.md), individual service offerings have varying rate limits which are enforced as an aggregate for the total usage of the account.

Consider the case of, `Search Service: Non-Batch Reverse` which has a limit of 250 queries per second (QPS).

|       | Approximate Maximum Rate Per Second | Actual Rate Per Second | Duration of sustained rate in seconds | Approximate total successful transactions |
| :---- | :---------------------------------- | :--------------------- | :------------------------------------ | :---------------------------------------- |
| token | 500                                 | 500                    | 60                                    | ~15000                                    |

Suppose 2 SAS tokens have been created for the same Azure Maps account assuming that the tokens produced equal amount of rate / ratio of 50%.

|         | Approximate Maximum Rate Per Second | Actual Rate Per Second | Duration of sustained rate in seconds | Approximate total successful transactions |
| :------ | :---------------------------------- | :--------------------- | :------------------------------------ | :---------------------------------------- |
| token 1 | 250                                 | 250                    | 60                                    | ~7500                                     |
| token 2 | 250                                 | 250                    | 60                                    | ~7500                                     |

### Understanding SAS token Access Control

SAS tokens use [Azure RBAC To control access](./azure-maps-authentication.md#Authorization-with-role-based-access-control) to REST APIs. When you create a SAS token, the prerequisite Managed Identity on the Map Account is assigned Azure RBAC role which grants access to specific REST API actions. Review [picking a role definition](./azure-maps-authentication.md#Picking-a-Role-Definition) to decide which APIs should be allowed by the application.

For a reason which access control should be revoked for SAS token(s) there are 2 options:

1. Regenerate the key which was used by the SAS token, the primaryKey or secondaryKey of the map account.
1. Remove the role assignment for the Managed Identity on the associated map account.

> [!WARNING]
> Revoking access control will cause your application to intentionally return `401 Unauthorized` or `403 Forbidden` from Azure Maps REST APIs which will cause application disruption for any existing SAS tokens using the key or managed identity.

### Create SAS tokens

To create SAS tokens you must have `Contributor` role access to both manage Azure Maps accounts and User Assigned Identities in the Azure subscription.

> [!IMPORTANT]
> Existing Azure Maps accounts created in the Azure location `global` cannot support a Managed Identity. An Azure Maps account should be created in a supported Azure locations for the account such as `east us`, `west europe`, `west us 2`, or any of the current supported Azure Maps account locations available.

First, you should create an [User Assigned Managed Identity](../active-directory/managed-identities-azure-resources/how-manage-user-assigned-managed-identities.md) in the same location as you want to create the Azure Maps account.

> [!TIP]
> Microsoft's general recommendation to pick the same location for the Managed Identity and the Azure Maps account.

Once a Managed Identity is created, you can create or update an Azure Maps account to attach the Manage Identity. To attach a Managed Identity, you can go use steps described in [manage your Azure Maps account](./azure-maps/how-to-manage-account-keys.md) to create the account and attach the Managed Identity.

After the account has been successfully created or updated with the Managed Identity; assign role based access control for the Managed Identity to an Azure Maps data role on the account scope. This will allow the managed identity to be given access to the Azure Maps REST APIs for your map account.

Now, you must create a SAS token using the Azure Management SDK tooling, List SAS operation on Account Management API, or the Azure Portal Shared Access Signature page of the Map account resource.

The parameters of the SAS token:

| Parameter Name   | Example Value                  | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| :--------------- | :----------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| signingKey       | primaryKey                     | The signingKey is used to create the signature of the SAS. Regenerating the `primarykey` of the map account will invalidate all SAS tokens issued with the primaryKey.                                                                                                                                                                                                                                                                                                                                                                                |
| principalId      | `GUID`                         | The principalId is the Object (principal) id of the user assigned managed identity which has been attached to the map account.                                                                                                                                                                                                                                                                                                                                                                                                                        |
| regions          | `[ "eastus", "westus2" ]`      | The regions control which regions the SAS token is allowed to be used in the Azure Maps REST [data-plane](../azure-resource-manager/management/control-plane-and-data-plane.md) API. Omitting regions parameter will allow the SAS token to be used without any constraints. When used in combination with an Azure Maps data-plane geographic endpoint like `us.atlas.microsoft.com` and `eu.atlas.microsoft.com` will allow the application to control usage with-in the specified geography. This allows prevention of usage in other geographies. |
| maxRatePerSecond | 500                            | Specify the approximate maximum request per second which the SAS token is granted. Once saturated, additional throughput will be rate limited with HTTP status code `429 Too Many Requests`.                                                                                                                                                                                                                                                                                                                                                          |
| start            | `2021-05-24T10:42:03.1567373Z` | The not before, start UTC date time of the token.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| expiry           | `2021-05-24T11:42:03.1567373Z` | The not after, end UTC date time of the token, the duration between start and expiry should be less than 365 days.                                                                                                                                                                                                                                                                                                                                                                                                                                    |

### Configuring application with SAS token

After the application receives a SAS token, the Azure Maps SDK and/or applications send an HTTPS request with the following required HTTP header in addition to other REST API HTTP headers:

| Header Name   | Value                |
| :------------ | :------------------- |
| Authorization | jwt-sas eyJ0e….HNIVN |

> [!NOTE] > `jwt-sas` is the authentication scheme to denote using SAS token. Do not include `x-ms-client-id` or other Authorization headers or `subscription-key` query string parameter.

## Restrict Cross Origin Resource Sharing

[!INCLUDE [preview features callout](./includes/preview-callout.md)]

Cross Origin Resource Sharing (CORS) is an HTTP feature that enables a web application running under one domain to access resources in another domain. Web browsers implement a security restriction known as [same-origin policy](https://www.w3.org/Security/wiki/Same_Origin_Policy) that prevents a web page from calling APIs in a different domain; CORS provides a secure way to allow one domain (the origin domain) to call APIs in another domain. See the [CORS specification](https://www.w3.org/TR/cors/) for details on CORS.

You can set a CORS rule on the Azure Maps account properties through Azure Maps Management APIs, SDKs, and Portal. Once you set the CORS rule for the service, then a properly authorized request made against the service from a different domain will be evaluated to determine whether it is allowed according to the rule you have specified.

> [!IMPORTANT]
> CORS is not an authorization mechanism. Any request made against a map account REST API when CORS is enabled must either have a valid map account authentication scheme such as Shared Key, Azure AD, or SAS token.
>
> CORS is supported for all map account pricing tiers, data-plane endpoints, and locations.

### Understanding CORS requests

A CORS request from an origin domain may consist of two separate requests:

- A preflight request, which queries the CORS restrictions imposed by the service. The preflight request is required unless the request method is a [simple method](https://www.w3.org/TR/cors/), meaning GET, HEAD, or POST.

- The actual request, made against the desired resource.

### Preflight Request

The preflight request queries the CORS restrictions that have been established for the map account. The web browser (or other user agent) sends an OPTIONS request that includes the request headers, method and origin domain. The map account service tries to fetch any CORS rules if account authentication is possible through the CORS preflight protocol. If authentication is not established, the maps service evaluates the intended operation based on a pre-configured set of CORS rules that specify which origin domains, request methods, and request headers may be specified on an actual request against the maps service. By default, a maps account is configured to allow all origins to enable seamless integration into web browsers.

If authentication was established and a CORS rule is enabled for the service and there is a CORS rule that matches the preflight request, the service responds with status code 200 (OK), and includes the required Access-Control headers in the response.

If CORS is not enabled for the service or no CORS rule matches the preflight request, the service will respond with status code `403 (Forbidden)`.

If the OPTIONS request doesn’t contain the required CORS headers (the Origin and Access-Control-Request-Method headers), the service will respond with status code `400 (Bad request)`.

Note that a preflight request is evaluated against the service and not against the requested resource. The account owner must have enabled CORS by setting the appropriate account properties in order for the request to succeed.

### Actual Request

Once the preflight request is accepted and the response is returned, the browser will dispatch the actual request against the map service. The browser will deny the actual request immediately if the preflight request is rejected.

The actual request is treated as normal request against the map service. The presence of the Origin header indicates that the request is a CORS request and the service will check the matching CORS rules. If a match is found, the Access-Control headers are added to the response and sent back to the client. If a match is not found, the response will return a `403 (Forbidden)` indicating a CORS origin error.

### Enable a CORS policy

When creating or updating an existing Map account, the Map account properties can specify the allowed origins to be configured. See an example below:

```json
{
  "location": "eastus",
  "sku": {
    "name": "G2"
  },
  "kind": "Gen2",
  "properties": {
    "cors": {
      "corsRules": [
        {
          "allowedOrigins": [
            "https://www.azure.com",
            "https://www.microsoft.com"
          ]
        }
      ]
    }
  }
}
```

You may specify only 1 CORS rule with a list of allowed origins. Each origin provided will allow for the HTTP requests to be made to Azure Maps REST APIs within the web browser of the specified origins. To remove CORS, you may use the Azure portal, SDKs, or management REST API to simply submit a `PUT` or a `PATCH` request with `cors: null`.

## Understanding billable transactions

Azure Maps does not count billing transactions for:

- 5xx HTTP Status Codes
- 401 (Unauthorized)
- 403 (Forbidden)
- 429 (TooManyRequests)
- CORS preflight requests

For understanding pricing tiers read more on [choosing a pricing tier](./choose-pricing-tier.md).

## Next steps

To learn more about Azure RBAC, see

> [!div class="nextstepaction"] > [Azure role-based access control](../role-based-access-control/overview.md)

To learn more about authenticating an application with Azure AD and Azure Maps, see

> [!div class="nextstepaction"] > [Manage authentication in Azure Maps](./how-to-manage-authentication.md)

To learn more about authenticating the Azure Maps Map Control with Azure AD, see

> [!div class="nextstepaction"] > [Use the Azure Maps Map Control](./how-to-use-map-control.md)
